# php-vk

**Важно**
Данный проект работает на версии php 5.6 и выше. Возможно, будет работать на 5.4 и 5.5. На более старых версиях работать **не будет**, так как в них отсутствует поддержка анонимных функций.

## Основное использование
Класс подключается обычным образом
`require_once "./classes/vk.php";`

После этого необходимо провести инициализацию приложения
`$vk = new VK([
    "app_id" => 'id вашего приложения',
    "secret_key" => 'защищённый ключ',
]);`

Теперь вы можете обращаться к открытым методам api.

`$result = $vk->query($method [, $args [, $token]]);`, где
**$method** - строка с названием метода (например, *wall.get*)
**$args** - массив с параметрами для запроса (например, *['owner_id' => 1, 'count' => 10]*). По умолчанию - пустой массив.
**$token** - наименование ключа доступа (например, *anonymous* для анонимного доступа). По умолчанию *anonymous* без авторизации, *user* с авторизацией

Выполнение запроса откладывается до первого использования его результата. Получить результат можно следующим образом

`$result([$field])`

**$field** может принимать значение *'response'* для полученного ответа или *'error'* при ошибке запроса. По умолчанию возвращается *'response'*, если в запросе не было ошибок, иначе *'error'*.

Примеры запросов можно посмотреть в файле index.php.

## Авторизация
Получить ссылку для авторизации приложения можно методом

`$vk->getAuthUrl([$scope [, $redirect_uri [, $response_type [, $params]]]])`

**$scope** - массив с правами доступа. По умолчанию пустой.
**$redirect_uri** - адрес, на который будет совершён переход после успешной авторизации приложения. По умолчанию https://oauth.vk.com/blank.html
**$response_type** - принимает 'code', если нужно вернуть код или (по умолчанию) 'token', если нужен токен
**$params** - дополнительные параметры

Если в **$response_type** вы указали 'code', то токен можно получить методом

`$vk->getAccessToken($code[, $redirect_uri]);`

При этом **$redirect_uri** должен совпадать с тем, который указан в **$vk->getAuthUrl**.

Полученный токен теперь можно сохранить

`$vk->setAccessToken($token [, $key]);`

Где **$key** - мнемоническое наименование ключа доступа, которое будет использоваться в **$vk->query**.

## Загрузка файлов в вк.
На текущий момент поддерживается только загрузка фотографий в альбом и на стену.

### Загрузка фотографий в альбом
`$vk->upload('photo.album', $url [, $params [, $token]])`
**$url** - путь до изображения на сервере либо массив путей для загрузки нескольких фотографий
**$params** - дополнительные параметры, указываемые в запросе (owner_id, album_id...)
**$token** - наименование ключа доступа.

Возвращается массив с сохранёнными фотографиями. Массив может содержать вложенные массивы из-за оптимизации загрузки.

### Загрузка фотографий на стену
`$vk->upload('photo.wall', $url [, $params [, $token]])`
Параметры аналогичны загрузке фотографий в альбом.
Возвращается массив с сохранёнными фотографиями.

## Особенности выполнения запросов
Для авторизованных запросов используется оптимизация при помощи метода *execute*. Таким образом, вместо 25 запросов может быть выполнен всего один! Запросы буферизуются для каждого ключа доступа и выполняются обычно при первой попытке получить результат одного из них.

Буферизованные запросы выполняются:
* При первой попытке получения результата одного из запросов
* При достижении 25 запросов в очереди (лимит vk на execute)
* При уничтожении класса, в том числе при завершении работы основного скрипта. Отложенный запрос будет выполнен в любом случае, даже если результат не был запрошен.

Следующие запросы не буферизуются:
* Без токена (в силу того, что execute требует токен)
* Непосредственно сам execute (не допускаются вложенные execute)
* Любые хранимые процедуры execute.<процедура>
